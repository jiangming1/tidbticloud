# tidbticloud
自己的tidb私有云
By jiangming rqy osdba

监控系统的运行状况，并在服务状态不佳时快速恢复服务。
及时更新数据库的补丁

跟踪问题的原因，例如系统故障或性能下降。
更新软件平台的系统故障原因，sql审核，sql慢sql修复。避免生产产生慢sql

及时更新软件和平台，比如安全补丁。

了解系统间的相互作用，以便在异常变更造成损失前进行规避。
熟悉代码 以便在异常变更前规避这种bug
预测未来的问题，并在问题出现之前加以解决（例如，容量规划）。

预测未来的问题。在容量不够前提前准备

建立部署、配置、管理方面的良好实践，编写相应工具。
编写相应的工具
执行复杂的维护任务，例如将应用程序从一个平台迁移到另一个平台。
执行复杂的变更
当配置变更时，维持系统的安全性。

定义工作流程，使运维操作可预测，并保持生产环境稳定。
铁打的营盘流水的兵，维持组织对系统的了解。
良好的可操作性意味着更轻松的日常工作，进而运维团队能专注于高价值的事情。数据系统可以通过各种方式使日常任务更轻松：

通过良好的监控，提供对系统内部状态和运行时行为的 可见性（visibility）。
为自动化提供良好支持，将系统与标准化工具相集成。
避免依赖单台机器（在整个系统继续不间断运行的情况下允许机器停机维护）。
提供良好的文档和易于理解的操作模型（“如果做 X，会发生 Y”）。
提供良好的默认行为，但需要时也允许管理员自由覆盖默认值。
有条件时进行自我修复，但需要时也允许管理员手动控制系统状态。
行为可预测，最大限度减少意外。


# 概述
https://github.com/pingcap/tidb是 https://pingcap.com/about-cn/公司自主设计、研发的开源分布式关系型数据库，主打 HTAP 和 MySQL 兼容替换。


# Why TiDB
TiDB 在墨天轮的 https://www.modb.pro/dbRank中常年排名第一。

在三方评测、专利和论文均不占优的情况下，TiDB 的整体得分仍能排名第一，说明在其它的得分项上非常突出。墨天轮对 TiDB 的整体评价是：“TiDB 为其他国产开源数据库发挥了示范性作用，一直在技术领域精耕细作，不断在市场中打磨产品，树立了良好的品牌形象。”
TiDB 关键词: 开源、技术、产品、品牌。

https://www.modb.pro/db/189802:

但在 DB-Engines 的 https://db-engines.com/en/ranking中，TiDB 只排到第 48 位 (OceanBase 排第 98 位)，相比 Oracle、MySQL、SQL Server 等老牌数据库来说，还有不少的差距。


在本次 Hackathon 中，我们支持 TiDB 和 TiKV 作为 ticloud 平台的后端，让 TiDB 和 TiKV 的用户也能享受到k8s平台带来的便利。

# 动机：
而对于每一个数据库用户而言，数据库备份/恢复也是一项刚需，对于企业而言，数据就是最基础最底层的资产，没有数据支撑，很多决策就缺乏强有力的依据。于企业而言，数据是资产但却很容易因为日常操作，机器损坏等各种原因导致数据的流失，很多数据的流失是不可逆的，可能会直接导致企业无法估量的损失。在此背景下，数据备份恢复是防范灾难于未然的强力手段，亦是保护企业重要资产的重要方式。据非官方统计，互联网头部企业中约有 11% 的成本分配在了数据备份管理上。

于每一个数据库用户而言，处理慢sql也是用户的日常工作。经常会发生tidb卡顿，在论坛提问题的用户很多遇到的就是这种情况。

mysql支撑起了当今互联网最赚钱的场景，在数据量越来越大的情况下mysql有点力不从心，所以才有了当下tidb的火爆现象。
但学习tidb成本较高，让当下的从业者望而却步，不断有用户通过论坛，群组等咨询tidb数据库的各种问题，我们把数据库团队的专业经验，嵌入到这个web应用里面。能相当于一个dba在管理应用。
做一个全面托管在云端的 SaaS 服务，把服务器一站式托管数据库的备份/恢复，支持 Time Travel （恢复到任意时间点），并且底层基于 S3 存储，存储成本极低。本地存在minio上。
简单的把tidb部署起来，部署在k8s上。让更多的用户参与使用，帮助用户tidb使用门槛高，成本高，专业性欠缺等会造成的使用难，费用贵等的基本问题。

当下的从业环境下，很多反馈在某些企业推广tidb遇到的最大问题是tidb部署问题和日常使用的各种，因其企业内部不具备专业的人员，无法独立完成部署，无法独立完成tidb的日常运维，直接导致tidb推广过程中的劝退。但对于我们能够专业使用tidb的人而言，使用tidb与使用mysql也是存在差异的，假设不具备专业经验的开发人员，是无法将mysql业务顺利迁移到tidb,更无法保障tidb数据库的稳定运行，影响tidb的用户体验。但其实，用k8s部署把细节隐藏后，就可以批量复制优化好的环境。

# tidb核心特性

一键水平扩容或者缩容
得益于 TiDB 存储计算分离的架构的设计，可按需对计算、存储分别进行在线扩容或者缩容，扩容或者缩容过程中对应用运维人员透明。
金融级高可用
数据采用多副本存储，数据副本通过 Multi-Raft 协议同步事务日志，多数派写入成功事务才能提交，确保数据强一致性且少数副本发生故障时不影响数据的可用性。可按需配置副本地理位置、副本数量等策略满足不同容灾级别的要求。
实时 HTAP
提供行存储引擎 TiKV、列存储引擎 TiFlash 两款存储引擎，TiFlash 通过 Multi-Raft Learner 协议实时从 TiKV 复制数据，确保行存储引擎 TiKV 和列存储引擎 TiFlash 之间的数据强一致。TiKV、TiFlash 可按需部署在不同的机器，解决 HTAP 资源隔离的问题。
云原生的分布式数据库
为云设计的分布式数据库，通过 TiDB Operator 可在公有云、私有云、混合云中实现部署工具化、自动化，依托公有云提供开箱即用的 TiDB Cloud 服务（DBaaS）。
兼容 MySQL 5.7 协议和 MySQL 生态
兼容 MySQL 5.7 协议、MySQL 常用的功能、MySQL 生态，应用无需或者修改少量代码即可从 MySQL 迁移到 TiDB。提供丰富的数据迁移工具帮助应用便捷完成数据迁移。

# TiDB 应用场景：
对数据一致性及高可靠、系统高可用、可扩展性、容灾要求较高的金融行业属性的场景：金融行业对数据一致性及高可靠、系统高可用、可扩展性、容灾要求较高。传统的解决方案是同城两个机房提供服务、异地一个机房提供数据容灾能力但不提供服务，此解决方案存在以下缺点：资源利用率低、维护成本高、RTO (Recovery Time Objective) 及 RPO (Recovery Point Objective) 无法真实达到企业所期望的值。TiDB 采用多副本 + Multi-Raft 协议的方式将数据调度到不同的机房、机架、机器，当部分机器出现故障时系统可自动进行切换，确保系统的 RTO <= 30s 及 RPO = 0。对存储容量、可扩展性、并发要求较高的海量数据及高并发的 OLTP 场景：随着业务的高速发展，数据呈现爆炸性的增长，传统的单机数据库无法满足因数据爆炸性的增长对数据库的容量要求，可行方案是采用分库分表的中间件产品或者 NewSQL 数据库替代、采用高端的存储设备等，其中性价比最大的是 NewSQL 数据库，例如：TiDB。TiDB 采用计算、存储分离的架构，可对计算、存储分别进行扩容和缩容，计算最大支持 512 节点，每个节点最大支持 1000 并发，集群容量最大支持 PB 级别。Real-time HTAP 场景：随着 5G、物联网、人工智能的高速发展，企业所生产的数据会越来越多，其规模可能达到数百 TB 甚至 PB 级别，传统的解决方案是通过 OLTP 型数据库处理在线联机交易业务，通过 ETL 工具将数据同步到 OLAP 型数据库进行数据分析，这种处理方案存在存储成本高、实时性差等多方面的问题。TiDB 在 4.0 版本中引入列存储引擎 TiFlash 结合行存储引擎 TiKV 构建真正的 HTAP 数据库，在增加少量存储成本的情况下，可以同一个系统中做联机交易处理、实时数据分析，极大地节省企业的成本。数据汇聚、二次加工处理的场景：当前绝大部分企业的业务数据都分散在不同的系统中，没有一个统一的汇总，随着业务的发展，企业的决策层需要了解整个公司的业务状况以便及时做出决策，故需要将分散在各个系统的数据汇聚在同一个系统并进行二次加工处理生成 T+0 或 T+1 的报表。传统常见的解决方案是采用 ETL + Hadoop 来完成，但 Hadoop 体系太复杂，运维、存储成本太高无法满足用户的需求。与 Hadoop 相比，TiDB 就简单得多，业务通过 ETL 工具或者 TiDB 的同步工具将数据同步到 TiDB，在 TiDB 中可通过 SQL 直接生成报表。
所以，基于这三个前提，你就会找到一个新思路：找到用户旅程中的通用路径，先不管核心不核心，极致优化用户（开发者）体验，然后利用云的基础设施把成本做低，最后利用流量入口 + PLG 走病毒式传播的路线。Cloud 这个项目的关键在于——第一，企业级用户进入tidb的成本能不能找到一个低门槛， 比如 SaaS；第二，这个模式一定要特别轻，不能特别贵，必须得找到一个非常自动化的切入点。因为一旦涉及到人工提供服务，这个事情就废了；第三，这个东西的用户群体要足够广， Database 本身是一个使用群体特别广的东西，而在 Database 里其实有一些东西的使用群体也特别广，那就是备份恢复。高可用。

# 目标：
本项目解决这些问题
### 1.tidb数据库多数据库部署麻烦的难题。如果你在企业里面维护100个tidb就会发现tidb和mysql不一样，mysql一台机器就够了，而tidb稳定使用需要最少9台服务器。还需要haproy做代理。这种部署的复杂程度会劝退很多人。而且在企业环境中，dev，test01，test02，uat01，uat02，prod这几个流水线下来dba的工作其实很累。对tidb在公司推广来说无疑是一座大山。
### 2.部署完成后dev test01 test02 uat01 uat02 需要接入报警系统。这个对没有经验的人来说是噩梦。
### 3.部署完成后各个环境的tidb运行会遇到卡顿 表结构同步等问题。tidb其实对于烂sql来说特别不友好，tidb会无限重启oom。我们需要限制slow sql的执行时间。怎么样寻找慢sql并解决。我们引入了远程数据库支援系统。rustdesk。让原先几千元一天的数据库维护变成免费搞定。不增加企业成本。
### 4.以上就是我实际在企业中用tidb遇到的问题。在工作上我都通过命令行解决了。现在需要增加工作效率。所以做了这个。

在 ToC 领域里，消费者会存在冲动消费的现象，这里需要有几个前提：第一，你马上就能理解这个东西是什么；第二，好像我一定需要；第三就是这东西得特便宜。这些都具备了，消费者就可能产生冲动消费的心理。所以，我们借用了 iCloud 换手机的概念，给大家制造一个错觉，这个东西我一定需要。因为大家都需要 iCloud ，我们就把这个概念平移到 DBA 领域。如果你是一个普通消费者，其实很容易就被这样的概念吸引。

# 动机：
我们的目标
过去做商业数据库的商业模式基本上就是收服务费，被保护的场景越重要，能收的服务费就越多。但是这个思路在“开源+云”时代发生了重大的变化：
就是帮助tidb在企业中推广应用。过去数据库是一个神秘的存在。公司会觉得他很重要，会付给dba很多薪资，生活中的确也很重要的，一个核心数据库的宕机会让企业整个公司业务无法开展。例如数据库出现按问题，整个必胜客收银都无法使用。而现在用tidb就能完全解决该类线上问题。

### 1.soft会变成一个特别普及的东西；软件开发也经历了3个阶段。付费软件--》共享软件（先使用后付费）--》免费软件（不要钱，黑盒不安全）--》开源软件（不要钱，看源码，大家一起修改，大家一起推广。病毒式传播。）
### 2.开源数据库超过了闭源数据库，它的成熟度已经基本上能够满足大多数核心的业务场景需求，开源数据库用户变成了一个非常庞大的群体；
### 3.k8s有一个好处，它把交付实现了标准化，并且使用的门槛降低了。当年 ToC 端出现了微信、支付宝等快速支付渠道，将支付门槛变得特别低，才有了爱奇艺这些订阅模式。我们现在数据库也可以先给人用，简单问题他自己解决。复杂问题交由tidb远程解决。疑难问题就交给专家解决。

所以，基于这三个前提，你就会找到一个新思路：找到用户旅程中的通用路径，先不管核心不核心，极致优化用户（开发者）体验，然后利用云的基础设施把成本做低，最后利用流量入口 + PLG 走病毒式传播的路线。Cloud 这个项目的关键在于——第一，企业级用户进入tidb的成本能不能找到一个低门槛， 比如 SaaS；第二，这个模式一定要特别轻，不能特别贵，必须得找到一个非常自动化的切入点。因为一旦涉及到人工提供服务，这个事情就废了；第三，这个东西的用户群体要足够广， Database 本身是一个使用群体特别广的东西，而在 Database 里其实有一些东西的使用群体也特别广，那就是备份恢复。高可用。

挑战：
看起来在企业整体业务运行中占比不大，但工程量繁杂，让他更易用，难度挺大的。
